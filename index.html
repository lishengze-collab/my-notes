<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MEMO PN-3.3.1</title>
    <style>
        :root {
            --bg-main: #f2f2f7; --text-main: #1c1c1e; --text-sec: #8e8e93;
            --accent: #34c759; --ios-blue: #007aff; --line: #c6c6c8;
            --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
        }
        .dark-mode {
            --bg-main: #000000; --text-main: #ffffff; --text-sec: #8e8e93;
            --line: #38383a;
        }
        
        @media (min-width: 500px) {
            body { background: #333 !important; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
            .app-container { width: 393px; height: 852px; border: 10px solid #1a1a1a; border-radius: 55px; position: relative; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); background: var(--bg-main); }
            .island { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); width: 110px; height: 35px; background: black; border-radius: 20px; z-index: 2000; }
        }
        @media (max-width: 500px) {
            body, .app-container { width: 100%; height: 100vh; margin: 0; background: var(--bg-main); }
            .island { display: none; }
        }

        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; transition: background 0.3s; overflow: hidden; }
        .app-container { display: flex; flex-direction: column; position: relative; }

        header { padding: calc(var(--safe-top) + 45px) 20px 10px; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .title { font-size: 17px; font-weight: 800; letter-spacing: 1px; color: var(--text-sec); cursor: pointer; }
        .theme-btn { font-size: 16px; cursor: pointer; margin-left: 10px; }
        .count-btn { font-size: 13px; color: var(--text-sec); font-weight: 600; cursor: pointer; }

        #notes-container { flex: 1; overflow-y: auto; padding: 10px 20px 180px; -webkit-overflow-scrolling: touch; }
        .note-row { border-left: 2px solid var(--line); padding-left: 15px; margin-bottom: 25px; transition: all 0.3s; position: relative; }
        .note-row.hidden-note { opacity: 0.1; filter: blur(5px); pointer-events: none; }
        .note-row.highlight { background: rgba(52, 199, 89, 0.2); border-radius: 0 8px 8px 0; }
        .ts { font-size: 12px; color: var(--text-sec); margin-bottom: 6px; font-weight: 500; }
        .content-text { font-size: 18px; line-height: 1.6; color: var(--text-main); word-break: break-all; white-space: pre-wrap; }
        .content-text img { max-width: 100%; border-radius: 12px; margin-top: 10px; }

        footer { position: absolute; bottom: 0; width: 100%; background: var(--bg-main); border-top: 0.5px solid var(--line); padding-bottom: var(--safe-bottom); z-index: 100; }
        .input-row { padding: 12px 16px 8px; display: flex; align-items: center; gap: 8px; }
        .sync-btn { background: var(--accent); color: white; border: none; height: 38px; padding: 0 14px; border-radius: 10px; font-size: 13px; font-weight: 800; cursor: pointer; }
        #note-input { flex: 1; background: #e3e3e6; border: none; border-radius: 10px; min-height: 38px; max-height: 150px; padding: 10px 12px; font-size: 16px; outline: none; box-sizing: border-box; resize: none; color: var(--text-main); }
        .dark-mode #note-input { background: #1c1c1e; }

        .toolbar { padding: 4px 16px 12px; display: flex; align-items: center; gap: 12px; }
        .search-icon { color: var(--accent); cursor: pointer; display: flex; align-items: center; }
        .tag-scroll { flex: 1; display: flex; gap: 8px; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        .tag-scroll::-webkit-scrollbar { display: none; }
        .tag-pill { background: #e3e3e6; padding: 6px 14px; border-radius: 14px; font-size: 13px; color: #666; font-weight: 500; }
        .dark-mode .tag-pill { background: #1c1c1e; color: #aaa; }
        .action-circle { width: 38px; height: 38px; border-radius: 50%; background: var(--accent); color: white; border: none; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: 0.2s; cursor: pointer; opacity: 0.9; }
        .action-circle:active { transform: scale(0.9); }

        /* iOS Style Alert */
        .ios-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 3000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .ios-alert { background: white; width: 270px; border-radius: 14px; overflow: hidden; text-align: center; }
        .dark-mode .ios-alert { background: #1c1c1e; color: white; }
        .alert-body { padding: 20px 15px; border-bottom: 0.5px solid var(--line); }
        .alert-title { font-weight: 600; font-size: 17px; margin-bottom: 5px; }
        .alert-input { width: 100%; border: 0.5px solid var(--line); padding: 8px; border-radius: 5px; margin-top: 10px; outline: none; box-sizing: border-box; }
        .alert-btns { display: flex; }
        .alert-btn { flex: 1; padding: 12px; color: var(--ios-blue); font-weight: 600; cursor: pointer; border: none; background: none; font-size: 16px; }
        .alert-btn:first-child { border-right: 0.5px solid var(--line); font-weight: 400; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="island"></div>
    <header>
        <div class="header-left">
            <div class="title" id="memo-title" onclick="handleMemoClick()">MEMO</div>
            <div class="theme-btn" onclick="toggleTheme()">‚òÄÔ∏è</div>
        </div>
        <div class="count-btn" id="word-count" ondblclick="hardLogout()">Total: 0</div>
    </header>

    <div id="notes-container"></div>

    <footer>
        <div class="input-row">
            <button class="sync-btn" onclick="syncAll()">SYNC</button>
            <textarea id="note-input" rows="1"></textarea>
        </div>
        <div class="toolbar">
            <div class="search-icon" onclick="toggleSearch()">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </div>
            <div class="tag-scroll" id="tag-bar"></div>
            <button class="action-circle" id="action-btn" onclick="handleAction()">‚á•</button>
        </div>
    </footer>
</div>

<div class="ios-overlay" id="ios-overlay">
    <div class="ios-alert">
        <div class="alert-body" id="alert-body">
            <div class="alert-title" id="alert-title">Z</div>
            <input type="password" class="alert-input" id="alert-input" placeholder="Token">
        </div>
        <div class="alert-btns">
            <button class="alert-btn" onclick="closeAlert()">Cancel</button>
            <button class="alert-btn" id="alert-confirm">OK</button>
        </div>
    </div>
</div>

<script>
    let notes = [];
    let isSearchMode = false;
    let lastEnterTime = 0;
    let config = {
        token: localStorage.getItem('gh_token') || '',
        id: localStorage.getItem('gh_gist_id') || '',
        verified: sessionStorage.getItem('memo_auth') === 'true'
    };

    const input = document.getElementById('note-input');
    const actionBtn = document.getElementById('action-btn');

    window.onload = () => {
        if(localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            document.querySelector('.theme-btn').innerText = 'üåô';
        }
        input.addEventListener('input', updateUI);
        input.addEventListener('keydown', handleKey);
        if(config.token && config.id) fetchData();
    };

    function updateUI() {
        input.style.height = '38px';
        input.style.height = Math.min(input.scrollHeight, 150) + 'px';
        actionBtn.innerText = input.value.length > 0 ? '‚Üë' : '‚á•';
        document.getElementById('word-count').innerText = `Total: ${notes.length}`;
    }

    function handleKey(e) {
        if(e.key === 'Enter') {
            const now = Date.now();
            const delay = now - lastEnterTime;
            lastEnterTime = now;
            
            if(isSearchMode) { e.preventDefault(); doSearch(); return; }

            const limit = input.value.length > 100 ? 250 : 350;
            if(delay < limit) {
                e.preventDefault();
                input.value = input.value.slice(0, -1);
                addNote();
            }
        }
    }

    function handleMemoClick() {
        if(config.verified) {
            config.verified = false;
            sessionStorage.removeItem('memo_auth');
            render();
        } else {
            showIOSAlert("Z", true, (val) => {
                if(val === config.token) {
                    config.verified = true;
                    sessionStorage.setItem('memo_auth', 'true');
                    render();
                }
            });
        }
    }

    function addNote() {
        let text = input.value.trim();
        if(!text) return;
        if(text === '098732 Delete') {
            notes = notes.filter(n => !n.isHidden);
            input.value = ''; saveData(); return;
        }
        if(/https?:\/\//.test(text) && !text.includes('#Ë∂ÖÈìæÊé•')) text += ' #Ë∂ÖÈìæÊé•';

        notes.unshift({ id: Date.now(), content: text, ts: new Date().toISOString(), isHidden: false });
        input.value = ''; updateUI(); saveData();
    }

    function render() {
        const container = document.getElementById('notes-container');
        container.innerHTML = '';
        notes.forEach(n => {
            if(n.isHidden && !config.verified) return;
            const row = document.createElement('div');
            row.className = `note-row ${n.isHidden ? 'hidden-note' : ''}`;
            row.id = `note-${n.id}`;
            row.onclick = () => { input.value += `\n> ${n.content}\n`; input.focus(); updateUI(); };
            
            // Format Timestamp
            const dateObj = new Date(n.ts);
            const timeStr = isNaN(dateObj) ? "Just now" : dateObj.toLocaleString();

            row.innerHTML = `
                <div class="ts">${timeStr}</div>
                <div class="content-text">${format(n.content)}</div>
            `;
            container.appendChild(row);
        });
        updateTags();
    }

    function format(t) {
        return t.replace(/&/g,"&amp;").replace(/</g,"&lt;")
                .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                .replace(/(https?:\/\/[^\s]+)/g, url => url.match(/\.(jpg|png|gif|webp)$/) ? `<img src="${url}">` : `<a href="${url}" target="_blank" style="color:var(--ios-blue);text-decoration:none;">${url}</a>`)
                .replace(/(#[^\s#]+)/g, '<span style="color:var(--ios-blue);font-weight:600;">$1</span>');
    }

    function updateTags() {
        const tags = new Set();
        notes.forEach(n => (n.content.match(/#[^\s#]+/g)||[]).forEach(t => tags.add(t)));
        const bar = document.getElementById('tag-bar');
        bar.innerHTML = '';
        tags.forEach(t => {
            const p = document.createElement('div');
            p.className = 'tag-pill'; p.innerText = t;
            let timer;
            p.addEventListener('touchstart', () => timer = setTimeout(() => {
                showIOSAlert(`Delete ${t}?`, false, () => {
                    notes.forEach(n => n.content = n.content.replace(t, '').trim());
                    saveData();
                });
            }, 800));
            p.addEventListener('touchend', () => clearTimeout(timer));
            bar.appendChild(p);
        });
    }

    function toggleSearch() {
        isSearchMode = !isSearchMode;
        input.placeholder = isSearchMode ? "Search notes..." : "";
        input.style.background = isSearchMode ? (document.body.classList.contains('dark-mode') ? "#2c2c2e" : "#fff9c4") : "";
        if(!isSearchMode) render();
    }

    function doSearch() {
        const q = input.value.toLowerCase();
        const target = notes.find(n => n.content.toLowerCase().includes(q));
        if(target) {
            const el = document.getElementById(`note-${target.id}`);
            el.scrollIntoView({behavior:'smooth', block:'center'});
            el.classList.add('highlight');
            setTimeout(() => el.classList.remove('highlight'), 2000);
        }
    }

    function handleAction() {
        if(input.value.length > 0) addNote();
        else {
            const start = input.selectionStart;
            input.value = input.value.substring(0, start) + "    " + input.value.substring(input.selectionEnd);
            input.selectionStart = input.selectionEnd = start + 4;
            updateUI();
        }
    }

    function showIOSAlert(title, showInput, onConfirm) {
        const overlay = document.getElementById('ios-overlay');
        const inputField = document.getElementById('alert-input');
        document.getElementById('alert-title').innerText = title;
        inputField.style.display = showInput ? 'block' : 'none';
        inputField.value = '';
        overlay.style.display = 'flex';
        document.getElementById('alert-confirm').onclick = () => {
            onConfirm(inputField.value);
            closeAlert();
        };
    }

    function closeAlert() { document.getElementById('ios-overlay').style.display = 'none'; }

    function toggleTheme() {
        const isDark = document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        document.querySelector('.theme-btn').innerText = isDark ? 'üåô' : '‚òÄÔ∏è';
    }

    function hardLogout() {
        showIOSAlert("Logout & Clear?", false, () => {
            localStorage.clear(); sessionStorage.clear(); window.location.reload();
        });
    }

    async function fetchData() {
        try {
            const r = await fetch(`https://api.github.com/gists/${config.id}`, {headers:{Authorization:`token ${config.token}`}});
            const d = await r.json();
            notes = JSON.parse(d.files['notes.json'].content || '[]');
            render(); updateUI();
        } catch(e) { console.error("Sync Error"); }
    }

    async function saveData() {
        render();
        try {
            await fetch(`https://api.github.com/gists/${config.id}`, {
                method:'PATCH', headers:{Authorization:`token ${config.token}`},
                body: JSON.stringify({files:{'notes.json':{content:JSON.stringify(notes)}}})
            });
        } catch(e) { console.error(e); }
    }

    function syncAll() { 
        if(!config.token) {
            showIOSAlert("Setup Gist ID", true, (id) => {
                showIOSAlert("Setup Token", true, (tk) => {
                    if(id && tk) {
                        localStorage.setItem('gh_gist_id', id);
                        localStorage.setItem('gh_token', tk);
                        window.location.reload();
                    }
                });
            });
        } else fetchData();
    }
</script>
</body>
</html>
