<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>PN-3 ç¬”è®°</title>
    <style>
        :root {
            --bg-color: #f2f2f7;
            --bubble-me: #007aff;
            --text-me: #ffffff;
            --timestamp-color: rgba(255, 255, 255, 0.7);
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "San Francisco", "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- Header --- */
        header {
            background: rgba(249, 249, 249, 0.94);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 0.5px solid rgba(0,0,0,0.1);
            padding-top: calc(10px + var(--safe-top)); 
            padding-bottom: 10px;
            padding-left: 15px;
            padding-right: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        h1 { font-size: 17px; font-weight: 600; margin: 0; flex: 1; text-align: center; }
        .header-btn { font-size: 16px; color: var(--bubble-me); background: none; border: none; cursor: pointer; padding: 5px; min-width: 40px; }

        /* --- Search --- */
        #search-container {
            background: rgba(249, 249, 249, 0.94);
            padding: 8px 15px;
            border-bottom: 0.5px solid rgba(0,0,0,0.05);
            display: none;
            animation: slideDown 0.2s ease;
        }
        #search-input { width: 100%; background: #e3e3e8; border: none; border-radius: 10px; padding: 8px 10px; font-size: 14px; outline: none; }

        /* --- List --- */
        #notes-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: calc(80px + var(--safe-bottom)); 
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: #f0f0f5; 
            -webkit-overflow-scrolling: touch; /* iOS smooth scroll */
        }

        .note-row { display: flex; justify-content: flex-end; width: 100%; animation: fadeIn 0.2s ease; }
        
        .bubble {
            background-color: var(--bubble-me);
            color: var(--text-me);
            padding: 10px 14px;
            border-radius: 18px;
            border-bottom-right-radius: 4px;
            max-width: 80%;
            position: relative;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            word-wrap: break-word;
            font-size: 16px;
            line-height: 1.4;
        }

        /* å›¾ç‰‡æ ·å¼ä¼˜åŒ– */
        .bubble img {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 5px;
            margin-bottom: 2px;
            display: block;
            cursor: pointer;
        }

        /* é“¾æ¥æ ·å¼ä¼˜åŒ– */
        .bubble a { color: white; text-decoration: underline; word-break: break-all; }

        /* éšè—æ€ */
        .note-row.hidden-state .bubble { background-color: #e5e5ea; color: #8e8e93; border: 1px dashed #c7c7cc; }
        .note-row.hidden-state .bubble img { opacity: 0.3; }
        .note-row.hidden-state .meta-info { color: #8e8e93; }

        .meta-info {
            display: flex; justify-content: flex-end; align-items: center;
            margin-top: 4px; font-size: 10px; color: var(--timestamp-color); gap: 8px;
        }
        .hide-btn { opacity: 0.6; cursor: pointer; font-size: 12px; }

        /* --- Input Area --- */
        .input-wrapper {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #f9f9f9; border-top: 0.5px solid rgba(0,0,0,0.15);
            padding: 10px 15px;
            padding-bottom: calc(10px + var(--safe-bottom));
            display: flex; align-items: flex-end; gap: 10px;
            z-index: 200;
        }

        #emoji-bar {
            position: fixed; bottom: calc(60px + var(--safe-bottom)); left: 0; width: 100%;
            background: #fff; border-top: 0.5px solid #ddd; padding: 10px;
            display: none; overflow-x: auto; white-space: nowrap; z-index: 190;
        }
        .emoji-item { font-size: 24px; margin: 0 8px; cursor: pointer; display: inline-block; }
        .tool-btn { font-size: 24px; background: none; border: none; padding: 0 5px; margin-bottom: 5px; cursor: pointer; }

        #note-input {
            flex: 1; border: 1px solid #d1d1d6; background: white; border-radius: 18px;
            padding: 9px 12px; font-size: 16px; outline: none; font-family: inherit;
            resize: none; max-height: 120px; min-height: 38px; line-height: 20px;
        }

        #send-btn {
            background: var(--bubble-me); color: white; border: none; border-radius: 50%;
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
            font-weight: bold; flex-shrink: 0; margin-bottom: 1px;
        }

        /* --- Settings Modal --- */
        #settings-modal, #image-viewer {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            display: none; align-items: center; justify-content: center; z-index: 300;
        }
        #settings-modal { background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); }
        .modal-content {
            background: rgba(255,255,255,0.95); width: 80%; max-width: 320px;
            padding: 25px; border-radius: 20px; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .modal-content input { width: 90%; margin: 10px 0; padding: 10px; border: 1px solid #e5e5ea; border-radius: 10px; background: #f2f2f7; }
        .btn-primary { background: var(--bubble-me); color: white; border: none; padding: 10px 0; border-radius: 12px; font-size: 16px; font-weight: 600; width: 100%; margin-top: 10px; cursor: pointer; }
        
        .toggle-row { display: flex; justify-content: space-between; align-items: center; margin: 15px 5px; font-size: 14px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { display: none; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 24px; width: 24px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #34c759; }
        input:checked + .slider:before { transform: translateX(22px); }

        /* --- Image Viewer --- */
        #image-viewer { background: rgba(0,0,0,0.95); z-index: 500; }
        #image-viewer img { max-width: 100%; max-height: 90%; object-fit: contain; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <button class="header-btn" onclick="toggleSearch()">ğŸ”</button>
    <h1>PN-3</h1>
    <button class="header-btn" id="sync-status-btn" onclick="openSettings()">åŒæ­¥</button>
</header>

<div id="search-container">
    <input type="text" id="search-input" placeholder="è¾“å…¥å…³é”®å­—æŸ¥æ‰¾..." oninput="handleSearch()">
</div>

<div id="notes-container">
    <div style="text-align: center; color: #999; margin-top: 60px; font-size: 13px;">
        PN-3 åˆå§‹åŒ–...
    </div>
</div>

<div id="emoji-bar">
    <span class="emoji-item" onclick="insertEmoji('ğŸ“…')">ğŸ“…</span>
    <span class="emoji-item" onclick="insertEmoji('âœ…')">âœ…</span>
    <span class="emoji-item" onclick="insertEmoji('ğŸ“')">ğŸ“</span>
    <span class="emoji-item" onclick="insertEmoji('ğŸ’¡')">ğŸ’¡</span>
    <span class="emoji-item" onclick="insertEmoji('âš ï¸')">âš ï¸</span>
    <span class="emoji-item" onclick="insertEmoji('ğŸ”´')">ğŸ”´</span>
    <span class="emoji-item" onclick="insertEmoji('ğŸŸ¢')">ğŸŸ¢</span>
    <span class="emoji-item" onclick="insertEmoji('ğŸ“Œ')">ğŸ“Œ</span>
    <span class="emoji-item" onclick="insertEmoji('ğŸ˜€')">ğŸ˜€</span>
    <span class="emoji-item" onclick="insertEmoji('ğŸ¤”')">ğŸ¤”</span>
    <span class="emoji-item" onclick="insertEmoji('ğŸ‘')">ğŸ‘</span>
    <span class="emoji-item" onclick="insertEmoji('ğŸ‘€')">ğŸ‘€</span>
    <span class="emoji-item" onclick="insertEmoji('ğŸš€')">ğŸš€</span>
</div>

<div class="input-wrapper">
    <button class="tool-btn" onclick="toggleEmoji()">ğŸ˜Š</button>
    <textarea id="note-input" rows="1" placeholder="è®°å½•..."></textarea>
    <button id="send-btn" onclick="addNote()">â†‘</button>
</div>

<div id="settings-modal">
    <div class="modal-content">
        <h3>é…ç½®ä¸­å¿ƒ</h3>
        <input type="password" id="github-token" placeholder="GitHub Token">
        <input type="text" id="gist-id" placeholder="Gist ID">
        <div class="toggle-row">
            <span>æ˜¾ç¤ºå·²éšè—</span>
            <label class="switch">
                <input type="checkbox" id="show-hidden-switch" onchange="toggleShowHidden()">
                <span class="slider"></span>
            </label>
        </div>
        <button class="btn-primary" onclick="saveSettings()">ä¿å­˜é…ç½®</button>
        <button onclick="closeSettings()" style="background:none; border:none; color:#8e8e93; margin-top:15px; font-size:14px;">å–æ¶ˆ</button>
    </div>
</div>

<div id="image-viewer" onclick="closeImageViewer()">
    <img id="full-image" src="" alt="Full View">
</div>

<script>
    let notes = [];
    let config = {
        token: localStorage.getItem('gh_token') || '',
        gistId: localStorage.getItem('gh_gist_id') || '',
        showHidden: localStorage.getItem('show_hidden') === 'true'
    };
    let isEmojiOpen = false;
    const container = document.getElementById('notes-container');
    const input = document.getElementById('note-input');
    
    // åˆå§‹åŒ–
    window.onload = function() {
        document.getElementById('show-hidden-switch').checked = config.showHidden;
        input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
        if (config.token && config.gistId) syncFromGist();
        else openSettings();
    };

    function getBeijingDate() {
        const now = new Date();
        const beijingString = now.toLocaleString("en-US", {timeZone: "Asia/Shanghai"});
        return new Date(beijingString);
    }

    function formatFullTime(isoString) {
        const date = new Date(isoString);
        const pad = n => String(n).padStart(2, '0');
        return `${pad(date.getDate())}/${pad(date.getMonth()+1)}/${String(date.getFullYear()).slice(-2)} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
    }

    // --- æ ¸å¿ƒæ›´æ–°ï¼šæ–‡æœ¬å¤„ç†ä¸å›¾ç‰‡æ¸²æŸ“ ---
    function processContent(text) {
        // 1. å®‰å…¨è½¬ä¹‰
        let safeText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        
        // 2. è¯†åˆ« URL
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        
        return safeText.replace(urlRegex, (url) => {
            // 3. æ£€æŸ¥æ˜¯å¦ä¸ºå›¾ç‰‡æ‰©å±•å
            if (url.match(/\.(jpeg|jpg|gif|png|webp)($|\?)/i)) {
                return `<img src="${url}" onclick="viewImage('${url}')">`;
            } else {
                return `<a href="${url}" target="_blank">${url}</a>`;
            }
        }).replace(/\n/g, '<br>');
    }

    function addNote() {
        const text = input.value.trim();
        if (!text) return;

        const now = getBeijingDate();
        notes.push({
            id: Date.now(),
            content: text,
            timestamp: now.toISOString(),
            isHidden: false
        });

        input.value = '';
        input.style.height = 'auto';
        if(isEmojiOpen) toggleEmoji();
        
        renderNotes();
        syncToGist();
        scrollToBottom();
    }

    function toggleHide(id) {
        const note = notes.find(n => n.id === id);
        if (note) {
            note.isHidden = !note.isHidden;
            renderNotes();
            syncToGist();
        }
    }

    function renderNotes(filterText = '') {
        container.innerHTML = '';
        const filtered = notes.filter(n => {
            const matchesSearch = n.content.toLowerCase().includes(filterText.toLowerCase());
            return matchesSearch && (config.showHidden || !n.isHidden);
        });

        if (filtered.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#ccc; margin-top:20px;">æ— å†…å®¹</div>';
            return;
        }

        filtered.forEach(note => {
            const row = document.createElement('div');
            row.className = `note-row ${note.isHidden ? 'hidden-state' : ''}`;
            const hideIcon = note.isHidden ? 'ğŸ‘ï¸' : 'ğŸš«';
            
            // ä½¿ç”¨æ–°çš„ processContent å¤„ç†å†…å®¹
            row.innerHTML = `
                <div class="bubble">
                    ${processContent(note.content)}
                    <div class="meta-info">
                        ${formatFullTime(note.timestamp)}
                        <span class="hide-btn" onclick="toggleHide(${note.id})">${hideIcon}</span>
                    </div>
                </div>
            `;
            container.appendChild(row);
        });
    }

    // --- å›¾ç‰‡æŸ¥çœ‹å™¨ ---
    window.viewImage = function(url) {
        // è¿™é‡Œé˜»æ­¢å†’æ³¡é˜²æ­¢è§¦å‘å…¶ä»–äº‹ä»¶ï¼Œè™½ç„¶åœ¨ bubble é‡Œä¸€èˆ¬æ²¡äº‹
        event.stopPropagation();
        document.getElementById('full-image').src = url;
        document.getElementById('image-viewer').style.display = 'flex';
    }

    window.closeImageViewer = function() {
        document.getElementById('image-viewer').style.display = 'none';
        document.getElementById('full-image').src = '';
    }

    // --- åŠŸèƒ½åŒº ---
    function toggleSearch() {
        const box = document.getElementById('search-container');
        if (box.style.display === 'block') {
            box.style.display = 'none';
            document.getElementById('search-input').value = '';
            renderNotes();
        } else {
            box.style.display = 'block';
            document.getElementById('search-input').focus();
        }
    }
    function handleSearch() { renderNotes(document.getElementById('search-input').value); }
    
    function toggleEmoji() {
        const bar = document.getElementById('emoji-bar');
        isEmojiOpen = !isEmojiOpen;
        bar.style.display = isEmojiOpen ? 'block' : 'none';
    }
    function insertEmoji(e) { input.value += e; input.focus(); }
    
    function scrollToBottom() { setTimeout(() => container.scrollTop = container.scrollHeight, 100); }

    // --- Sync ---
    async function syncFromGist() {
        if (!config.token || !config.gistId) return;
        const btn = document.getElementById('sync-status-btn');
        btn.innerText = '...';
        try {
            const res = await fetch(`https://api.github.com/gists/${config.gistId}`, {
                headers: { 'Authorization': `token ${config.token}` }, cache: "no-store"
            });
            const data = await res.json();
            notes = JSON.parse(data.files['notes.json'].content || '[]');
            renderNotes();
            scrollToBottom();
            btn.innerText = 'åŒæ­¥';
        } catch (e) {
            console.error(e);
            btn.innerText = 'é‡è¯•';
        }
    }

    async function syncToGist() {
        if (!config.token || !config.gistId) return;
        const btn = document.getElementById('sync-status-btn');
        btn.innerText = 'â†‘';
        try {
            await fetch(`https://api.github.com/gists/${config.gistId}`, {
                method: 'PATCH',
                headers: { 'Authorization': `token ${config.token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ files: { 'notes.json': { content: JSON.stringify(notes) } } })
            });
            btn.innerText = 'åŒæ­¥';
        } catch (e) {
            btn.innerText = 'å¤±è´¥';
        }
    }

    // Settings
    function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; document.getElementById('github-token').value = config.token; document.getElementById('gist-id').value = config.gistId; }
    function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
    function toggleShowHidden() { config.showHidden = document.getElementById('show-hidden-switch').checked; }
    function saveSettings() {
        const t = document.getElementById('github-token').value.trim();
        const g = document.getElementById('gist-id').value.trim();
        if(t && g) {
            localStorage.setItem('gh_token', t); localStorage.setItem('gh_gist_id', g); localStorage.setItem('show_hidden', config.showHidden);
            config.token = t; config.gistId = g;
            closeSettings(); syncFromGist();
        } else alert('è¯·å¡«å†™å®Œæ•´');
    }

    input.addEventListener('keydown', e => { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); addNote(); }});
</script>
</body>
</html>
