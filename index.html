<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Private Memo</title>
    <style>
        :root {
            --bg-color: #e5ddd5;
            --bubble-me: #dcf8c6;
            --text-main: #303030;
            --timestamp-color: #8696a0;
            --accent-green: #25d366;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        /* ç¡®ä¿1åŒºåŸŸå’Œ2åŒºåŸŸèƒŒæ™¯è‰²å®Œå…¨ä¸€è‡´ä¸ºçº¯ç™½ */
        html { background-color: #ffffff; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header: é€‚é…çµåŠ¨å²›å¹¶ç¡®ä¿æŒ‰é’®å¯ç‚¹ --- */
        header {
            background: #ffffff;
            position: relative;
            padding-top: var(--safe-top); 
            padding-bottom: 12px;
            padding-left: 15px;
            padding-right: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 999; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        h1 { 
            font-size: 17px; 
            font-weight: 700; 
            margin: 0; 
            margin-top: 22px; /* é¿å¼€çµåŠ¨å²›é»‘åŒº */
            color: #41525d; 
            flex: 1; 
            text-align: center; 
        }

        .header-btn { 
            font-size: 18px; 
            color: #54656f; 
            background: none; 
            border: none; 
            cursor: pointer; 
            min-width: 44px; 
            min-height: 44px;
            margin-top: 18px; 
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- Search Container --- */
        #search-container {
            background: #ffffff; 
            padding: 5px 15px 12px 15px; 
            display: none; 
            position: relative;
            z-index: 998;
            border-bottom: 0.5px solid #eee;
        }
        #search-input { 
            width: 100%; background: #f0f2f5; border: none; border-radius: 10px; 
            padding: 10px 12px; font-size: 14px; outline: none; box-sizing: border-box;
        }

        /* --- Notes List --- */
        #notes-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px 15px;
            padding-bottom: 120px; 
            display: flex;
            flex-direction: column;
            gap: 10px;
            -webkit-overflow-scrolling: touch;
        }

        .note-row { display: flex; justify-content: flex-end; width: 100%; animation: fadeIn 0.2s ease; }
        
        .bubble {
            background-color: var(--bubble-me);
            color: var(--text-main);
            padding: 8px 12px 6px 12px;
            border-radius: 10px 0px 10px 10px;
            max-width: 85%;
            position: relative;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.12);
            word-wrap: break-word;
            font-size: 16px;
            line-height: 1.5;
        }

        .bubble img { max-width: 100%; border-radius: 6px; margin-top: 5px; display: block; }
        .bubble a { color: #0645ad; text-decoration: underline; }
        .note-row.hidden-state .bubble { background-color: #f1f1f1; color: #999; border: 1px dashed #ccc; box-shadow: none; }

        .meta-info {
            display: flex; justify-content: flex-end; align-items: center;
            margin-top: 4px; font-size: 11px; color: var(--timestamp-color); gap: 4px;
        }
        .check-mark { color: var(--accent-green); font-weight: bold; font-size: 14px; }
        .hide-btn { margin-right: 5px; opacity: 0.5; }

        /* --- Input Area --- */
        .input-wrapper {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #f0f2f5; padding: 10px;
            padding-bottom: calc(15px + var(--safe-bottom));
            display: flex; align-items: flex-end; gap: 10px; z-index: 1000;
        }

        #note-input {
            flex: 1; border: none; background: white; border-radius: 20px;
            padding: 10px 15px; font-size: 16px; outline: none; font-family: inherit;
            resize: none; max-height: 150px; min-height: 40px; line-height: 20px; box-sizing: border-box;
        }

        #send-btn {
            background: #00a884; color: white; border: none; border-radius: 50%;
            width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        #emoji-bar {
            position: fixed; bottom: calc(75px + var(--safe-bottom)); left: 10px; right: 10px;
            background: #fff; border-radius: 15px; padding: 10px; display: none;
            overflow-x: auto; white-space: nowrap; z-index: 1100; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        .emoji-item { font-size: 26px; margin: 0 10px; cursor: pointer; display: inline-block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <button class="header-btn" onclick="toggleSearch()">ğŸ”</button>
    <h1>Private Memo</h1>
    <button class="header-btn" id="sync-status-btn" onclick="openSettings()">åŒæ­¥</button>
</header>

<div id="search-container">
    <input type="text" id="search-input" placeholder="æœç´¢æ¶ˆæ¯..." oninput="handleSearch()">
</div>

<div id="notes-container"></div>

<div id="emoji-bar">
    <span class="emoji-item" onclick="insertEmoji('ğŸ“…')">ğŸ“…</span>
    <span class="emoji-item" onclick="insertEmoji('âœ…')">âœ…</span>
    <span class="emoji-item" onclick="insertEmoji('ğŸ“')">ğŸ“</span>
    <span class="emoji-item" onclick="insertEmoji('ğŸ’¡')">ğŸ’¡</span>
    <span class="emoji-item" onclick="insertEmoji('ğŸ“Œ')">ğŸ“Œ</span>
    <span class="emoji-item" onclick="insertEmoji('ğŸ˜€')">ğŸ˜€</span>
    <span class="emoji-item" onclick="insertEmoji('ğŸ‘')">ğŸ‘</span>
    <span class="emoji-item" onclick="insertEmoji('ğŸš€')">ğŸš€</span>
</div>

<div class="input-wrapper">
    <button class="header-btn" style="font-size:26px; margin-top:0; min-height:auto" onclick="toggleEmoji()">ğŸ˜Š</button>
    <textarea id="note-input" rows="1" placeholder="è¾“å…¥è®°å½•..."></textarea>
    <button id="send-btn" onclick="addNote()">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M1.101 21.757L23.8 12.028 1.101 2.3l.011 7.912 13.623 1.816-13.623 1.817-.011 7.912z"></path></svg>
    </button>
</div>

<div id="settings-modal" style="position:fixed; top:0; left:0; right:0; bottom:0; display:none; align-items:center; justify-content:center; z-index:2000; background:rgba(0,0,0,0.5); backdrop-filter:blur(4px);">
    <div style="background:white; width:85%; max-width:320px; padding:25px; border-radius:20px; text-align:center;">
        <h3>åŒæ­¥è®¾ç½®</h3>
        <input type="password" id="github-token" placeholder="GitHub Token" style="width:100%; margin:10px 0; padding:12px; border:1px solid #ddd; border-radius:10px; box-sizing:border-box;">
        <input type="text" id="gist-id" placeholder="Gist ID" style="width:100%; margin:10px 0; padding:12px; border:1px solid #ddd; border-radius:10px; box-sizing:border-box;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin:15px 0;">
            <span style="font-size:14px; color: #54656f;">æ˜¾ç¤ºéšè—å†…å®¹</span>
            <input type="checkbox" id="show-hidden-switch" onchange="toggleShowHidden()" style="width:auto">
        </div>
        <button onclick="saveSettings()" style="background:#00a884; color:white; border:none; padding:12px; border-radius:10px; width:100%; font-weight:600;">ä¿å­˜å¹¶æ‹‰å–æ•°æ®</button>
        <button onclick="closeSettings()" style="background:none; border:none; color:#8696a0; margin-top:15px;">å…³é—­</button>
    </div>
</div>

<div id="image-viewer" onclick="this.style.display='none'" style="position:fixed; top:0; left:0; right:0; bottom:0; display:none; align-items:center; justify-content:center; z-index:3000; background:rgba(0,0,0,0.95);">
    <img id="full-image" src="" style="max-width:95%; max-height:95%; border-radius:8px;">
</div>

<script>
    let notes = [];
    let config = {
        token: localStorage.getItem('gh_token') || '',
        gistId: localStorage.getItem('gh_gist_id') || '',
        showHidden: localStorage.getItem('show_hidden') === 'true'
    };
    let isEmojiOpen = false;
    const container = document.getElementById('notes-container');
    const input = document.getElementById('note-input');

    window.onload = function() {
        document.getElementById('show-hidden-switch').checked = config.showHidden;
        input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
        if (config.token && config.gistId) syncFromGist();
        else openSettings();
    };

    function getBeijingDate() {
        const now = new Date();
        const bjs = now.toLocaleString("en-US", {timeZone: "Asia/Shanghai"});
        return new Date(bjs);
    }

    function formatFullTime(isoString) {
        const d = new Date(isoString);
        const pad = n => String(n).padStart(2, '0');
        return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${String(d.getFullYear()).slice(-2)} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function processContent(text) {
        let safeText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        return safeText.replace(urlRegex, (url) => {
            if (url.match(/\.(jpeg|jpg|gif|png|webp|bmp)($|\?)/i)) {
                return `<img src="${url}" onclick="event.stopPropagation(); viewImage('${url}')">`;
            } else {
                return `<a href="${url}" target="_blank">${url}</a>`;
            }
        }).replace(/\n/g, '<br>');
    }

    function renderNotes(filterText = '') {
        container.innerHTML = '';
        const filtered = notes.filter(n => {
            const matchesSearch = n.content.toLowerCase().includes(filterText.toLowerCase());
            return matchesSearch && (config.showHidden || !n.isHidden);
        });

        filtered.forEach(note => {
            const row = document.createElement('div');
            row.className = `note-row ${note.isHidden ? 'hidden-state' : ''}`;
            row.innerHTML = `
                <div class="bubble">
                    ${processContent(note.content)}
                    <div class="meta-info">
                        <span class="hide-btn" onclick="toggleHide(${note.id})">${note.isHidden ? 'ğŸ‘ï¸' : 'ğŸš«'}</span>
                        ${formatFullTime(note.timestamp)}
                        <span class="check-mark">âœ“</span>
                    </div>
                </div>
            `;
            container.appendChild(row);
        });
        scrollToBottom();
    }

    async function syncFromGist() {
        if (!config.token || !config.gistId) return;
        const btn = document.getElementById('sync-status-btn');
        btn.innerText = 'è¯»å–ä¸­';
        try {
            const res = await fetch(`https://api.github.com/gists/${config.gistId}`, {
                headers: { 'Authorization': `token ${config.token}` }, cache: "no-store"
            });
            const data = await res.json();
            notes = JSON.parse(data.files['notes.json'].content || '[]');
            renderNotes();
            btn.innerText = 'åŒæ­¥';
        } catch (e) { btn.innerText = 'é”™è¯¯'; }
    }

    async function syncToGist() {
        if (!config.token || !config.gistId) return;
        const btn = document.getElementById('sync-status-btn');
        btn.innerText = 'æ›´æ–°ä¸­';
        try {
            await fetch(`https://api.github.com/gists/${config.gistId}`, {
                method: 'PATCH',
                headers: { 'Authorization': `token ${config.token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ files: { 'notes.json': { content: JSON.stringify(notes) } } })
            });
            btn.innerText = 'åŒæ­¥';
        } catch (e) { btn.innerText = 'å¤±è´¥'; }
    }

    function addNote() {
        const text = input.value.trim();
        if (!text) return;
        notes.push({ id: Date.now(), content: text, timestamp: getBeijingDate().toISOString(), isHidden: false });
        input.value = ''; input.style.height = 'auto';
        renderNotes(); syncToGist();
    }

    function toggleHide(id) {
        const n = notes.find(n => n.id === id);
        if (n) { n.isHidden = !n.isHidden; renderNotes(); syncToGist(); }
    }

    function toggleSearch() {
        const box = document.getElementById('search-container');
        box.style.display = (box.style.display === 'block') ? 'none' : 'block';
        if(box.style.display === 'block') document.getElementById('search-input').focus();
    }

    function handleSearch() { renderNotes(document.getElementById('search-input').value); }
    function toggleEmoji() { isEmojiOpen = !isEmojiOpen; document.getElementById('emoji-bar').style.display = isEmojiOpen ? 'block' : 'none'; }
    function insertEmoji(e) { input.value += e; input.focus(); }
    function viewImage(url) { document.getElementById('full-image').src = url; document.getElementById('image-viewer').style.display = 'flex'; }
    function scrollToBottom() { container.scrollTop = container.scrollHeight; }
    function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
    function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
    function toggleShowHidden() { config.showHidden = document.getElementById('show-hidden-switch').checked; localStorage.setItem('show_hidden', config.showHidden); renderNotes(); }
    
    function saveSettings() {
        config.token = document.getElementById('github-token').value.trim();
        config.gistId = document.getElementById('gist-id').value.trim();
        localStorage.setItem('gh_token', config.token);
        localStorage.setItem('gh_gist_id', config.gistId);
        closeSettings(); syncFromGist();
    }

    input.addEventListener('keydown', e => { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); addNote(); }});
</script>
</body>
</html>
